var https=require("https"),http=require("http"),fs=require("fs"),path=require("path"),Q=require("q"),progress=function(){function a(){"false"===this.el.dataset.show?(this.el.dataset.show="true",display="block"):(this.el.dataset.show="false",display="none"),this.el.style.display=display}function b(a,c){return this.el.setAttribute(a,c),b}var c=function(){};return c.prototype={initProgress:function(){var c=[].slice.call(arguments);this.el=c.shift();var d=c.pop(),e=c[0]||0;this.el.dataset.show=!1,a.call(this),b.call(this,"max",d).call(this,"value",e)},setValue:function(a){b.call(this,"value",a)},end:function(c){a.call(this),b.call(this,"max",0).call(this,"value",0),c.call(this)}},c}();!function(a){var b=function(a,b,c){c=c||{};var d=Q.defer(),e=new XMLHttpRequest;return e.open(b,a,!0),"post"===b.toLowerCase()&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.withCookie&&delete c.withCookie&&(e.withCredentials=!0),Object.keys(c).forEach(function(a){e.setRequestHeader(a,c[a])}),e.onload=function(){d.resolve(JSON.parse(this.responseText))},e.error=function(){d.reject("network error")},e.onprogress=function(a){a.lengthComputable&&d.notify(a.loaded/a.total)},e.send(c.data||null),d.promise},c=function(a,b){var d,e=(a.split(".").pop(),a.split("/").pop()),f=path.join(b.path,e),g=Q.defer();return d=b.https===!0?https:http,d.get(a,function(a){var d="",e=0,h=a.statusCode;return 301===h&&a.headers.location?c(a.headers.location,b).then(function(a){g.resolve(a)},function(a){g.reject(a)},function(a){g.notify(a)}):void(h>=200&&300>h||304===h?(a.setEncoding("binary"),a.on("data",function(a){d+=a,e+=a.length,g.notify(e)}),a.on("end",function(){g.resolve({pathname:f,chunk:d})})):301!==h&&g.reject(a))}),g.promise},d=function(a,b){var c=Q.defer();try{fs.writeFileSync(a,b,"binary"),c.resolve(a)}catch(d){c.reject(d)}return c.promise},e=function(a){var b=Q.defer();return fs.readFile(a,function(a,c){a?b.reject(a):b.resolve(c.toString())}),b.promise},f=function(a,b){for(var c;!(b(a)||(a=a.parentNode,c=a===document)););return c?null:a},g=function(a){var b,c;try{return b=document.createElement("div"),b.innerHTML=a,c=b.firstElementChild}finally{b=c=null}},h=function(){var a=document.getElementById("directory"),b=Q.defer(),c=function(){b.resolve(this.value),a.removeEventListener("change",c,!1)};return a.addEventListener("change",c,!1),a.click(),b.promise},i=function(a){var b=this instanceof i?this:Object.create(i.prototype);return b.target=a.target,b.data=a.data,b.tpl=a.tpl,b.onDone=a.onDone,b.init(),b};i.prototype=Object.create(progress.prototype),i.prototype.init=function(){var a=this;this.taskEl=g(this.tpl.call(this,this.data)),this.bar=this.target.appendChild(this.taskEl).querySelector("progress"),h().then(function(b){return a.initProgress(a.bar,a.data.file_size),c(a.data.file_url,{https:!0,path:b})}).then(function(a){return d(a.pathname,a.chunk)},function(a){console.log(a)},function(b){a.setValue(b)}).then(function(b){a.end(),console.log(b),console.log(a.onDone)},function(a){console.log(a)})},a.ajax=b,a.readFile=e,a.findParent=f,a.addDownloadTask=i}(this),function(a,b,c){var d=Array.prototype,e=function(){};[].forEach||(d.forEach=function(a,b){for(var c=0,d=this.length;d>c;c++)a.apply(b||null,[this[c],c,this]);return this}),[].map||(d.map=function(a,b){for(var c=[],d=0,e=this.length;e>d;d++)c.push(a.apply(b||null,[this[d],d,this]));return c}),[].indexOf||(d.indexOf=function(a){for(var b,c=0,d=this.length;d>c;c++)if(this[c]==a){b=c;break}return b}),[].some||(d.some=function(a,b){for(var c=!1,d=0,e=this.length;e>d;d++)if(a.apply(b||null,[this[d],d,this])===!0)return c=!0;return c}),[].fill||(d.fill=function(a){for(var b=[],c=0;c<this.length;c++)b.push(a);return b}),e=b.getElementsByClassName?function(a,b){return a.getElementsByClassName(b)}:function(a,b){a=a||document;for(var d,e=[],f=a.getElementsByTagName("*"),g=new RegExp("(^|\\s)"+b+"(\\s|$)"),h=0,i=f.length;i>h;h++)d=f[h],g.test(d.className)&&e.push(d);return f=c,e},"function"!=typeof Object.create&&!function(){var a=function(){};Object.create=function(b){if(arguments.length>1)throw Error("Second argument not supported");if(null===b)throw Error("Cannot set a null [[Prototype]]");if("object"!=typeof b)throw TypeError("Argument must be an object");return a.prototype=b,new a}}();var f=function(a){this.colPrefix=a.colPrefix||+new Date+"seed",this.colWrap=a.colWrap,this.colwrapStyle=this.colWrap.style,this.colClass=a.colClass,this.imgClass=a.imgClass,this.colWidth=a.colWidth,this.flexWidth=a.flexWidth,this.gutterWidth=a.gutterWidth||20,this.gutterHeight=a.gutterHeight||20,this.colNum=a.colNum||4,this.maxColNum=a.maxColNum,this.minColNum=a.minColNum,this.specialCol=a.columnHeight&&a.columnHeight.slice(),this.specialColHeight=a.specialColHeight||0,this.columnHeight=a.columnHeight||new Array(this.colNum||4).fill(0),this.resize=a.resize,this.onResize=a.onResize,this.pageNum=a.pageNum||15,this.fetch=a.fetch,this.fetchBtn=a.fetchBtn,this.animate=a.animate,this.__lock=this.sid=this.page=0,this.__lockCount=this.pageNum,this.data=[],this.distance=a.distance||0,this.tpl=a.template,this.maxPage=a.maxPage,this.maxNum=a.maxNum,this.onPrepend=a.onPrepend,this.onDone=a.onDone,this.onprocess=a.onprocess,this.imgDone=a.imgDone,this.imgError=a.imgError,this.eventStatus=!0,this.__imgQueue=[],this.__animateQueue=[],this.todo=[],this.hasLayout=a.hasLayout||!1,this.customProperty=a.customProperty||{},this.initialize()};f.prototype=Object.create({initialize:function(){this.fetchBtn?(this.fetchBtn._display=this.fetchBtn.style.display,this.bindFetchEvent()):this.bindDefaultFetchEvent(),this.resize&&(this.prepareResize(!1),this.bindResizeEvent()),this.__lock=1,this.mainProcess()},mainProcess:function(){var a=this;!this.maxPage&&!this.maxNum||this.maxPage&&this.page<this.maxPage||this.maxNum&&this.sid<this.maxNum?(this.fetchBtn&&(this.fetchBtn.style.display="none"),this.onprocess&&this.onprocess(),this.fetch(function(b,c){if(a.data=b,b.length){a.__lockCount=b.length;var d=b.map(function(a){return a[c]});a.makeImgQueue(d),a.hasLayout&&(b.forEach(function(b,c){b.sid=c,a.procssConfig(b)}),f.__handleOpacity(a),a.resetStauts())}else a.__lockCount=a.pageNum,a.resetStauts()})):this.switchEvent(!1)},fetchData:function(){this.__lock||(this.__lock=1,this.mainProcess())},bindFetchEvent:function(){var a=this;this.fetchBtn.onclick=function(){a.fetchData()}},bindDefaultFetchEvent:function(){var c,d=this,e=this.distance;this.fnHandler=function(){clearTimeout(c),c=setTimeout(function(){var c=b.body.scrollTop+b.documentElement.scrollTop,f=a.innerHeight||b.documentElement.clientHeight,g=b.documentElement.scrollHeight||b.body.scrollHeight;c+f>=g-e&&d.fetchData()},200)},f.__addEvent(a,"scroll",this.fnHandler)},bindResizeEvent:function(){var b,c=this,d=function(){clearTimeout(b),b=setTimeout(function(){c.prepareResize(!0)},200)};f.__addEvent(a,"resize",d)},prepareResize:function(c){var d=this.colWidth+this.gutterWidth,e=a.innerWidth||b.documentElement.clientWidth,f=parseInt(e/d,10);if(f!==this.colNum){this.maxColNum&&f>this.maxColNum&&(f=this.maxColNum),this.minColNum&&f<this.minColNum&&(f=this.minColNum);var g=d*f;this.colWrap.style.cssText+=";width: "+g+"px;";this.columnHeight=this.specialCol?f<this.specialCol.length?this.specialCol.slice().splice(0,f):this.specialCol.slice().concat(new Array(f-this.specialCol.length).fill(this.specialColHeight)):new Array(f).fill(0),this.onResize&&this.onResize.call(this,f),c&&this.doResize(),this.colNum=f}},doResize:function(){var a=this,b=function(b){var c=f.__min(a.columnHeight),d=c.value,e=c.index*(a.colWidth+a.gutterWidth);b.el.style.cssText+=";top: "+d+"px;left: "+e+"px;",a.columnHeight[f.__min(a.columnHeight).index]+=b.layout,a.colwrapStyle.cssText+=";height: "+f.__max(a.columnHeight).value+"px"};this.todo.forEach(function(a){b(a)})},makeImgQueue:function(a){var b=this;a.forEach(function(a,c){var d=new Image;d.onload=function(){b.__lockCount--,b.imgDone&&b.imgDone.call(b,d)},d.onerror=function(a){b.__lockCount--,b.__imgQueue.splice(b.__imgQueue.indexOf(d),1),b.imgError&&b.imgError.call(b,a)},d.src=a,d.sid=c,b.__imgQueue.push(d)}),this.hasLayout||f.__calcImgSize(this,this.procssConfig)},procssConfig:function(a){var b,c,d,e,g,h,i=this;this.hasLayout?(d=this.customProperty.width,e=this.customProperty.height,h={naturalwidth:a[d],naturalheight:a[e]}):(d="width",e="height",h={naturalwidth:a.naturalWidth?a.naturalWidth:a.width,naturalheight:a.naturalHeight?a.naturalHeight:a.height}),g=f.__min(this.columnHeight),b=g.value,c=g.index*(this.colWidth+this.gutterWidth),this.replaceTpl({top:b,left:c,height:i.flexWidth*a[e]/a[d],sid:this.sid,sidIndex:a.sid},h),this.sid++},replaceTpl:function(a,c){var d,g=this.data[a.sidIndex],h=b.createElement("div"),i="";i=this.tpl(g),h.innerHTML=i,h.className=this.colClass;try{h.dataset.id=this.colPrefix+a.sid}catch(j){h["data-id"]=this.colPrefix+a.sid}if(h.style.cssText+=";top: "+a.top+"px;left: "+a.left+"px;",d=e(h,this.imgClass)[0],d.width=this.flexWidth,d.height=a.height,c)for(var k in c)c.hasOwnProperty(k)&&(d[k]=c[k]);this.animate&&this.resize&&f.__supportCSS3&&(h.style.cssText+=";-webkit-transition: all linear .5s;-moz-transition: all linear .5s;-ms-transition: all linear .5s;-o-transition: all linear .5s;transition: all linear .5s;"),this.animate&&(d.style.filter="alpha(opacity=0)",d.style.cssText+=";opacity: 0;-webkit-transition: opacity linear .5s;-moz-transition: opacity linear .5s;-ms-transition: opacity linear .5s;-o-transition: opacity linear .5s;transition: opacity linear .5s;"),this.onPrepend&&this.onPrepend.call(this,h),this.colWrap.appendChild(h);var l=h.offsetHeight+this.gutterHeight;this.columnHeight[f.__min(this.columnHeight).index]+=l,this.todo.push({el:h,layout:l}),this.colwrapStyle.cssText+=";height: "+f.__max(this.columnHeight).value+"px",this.animate&&this.animation(d)},animation:function(a){f.__supportCSS3?a.style.cssText+="opacity: 1":this.__animateQueue.push(a)},switchEvent:function(b){b!==!0||this.eventStatus?b===!1&&(this.fetchBtn?this.fetchBtn.onclick=c:f.__detachEvent(a,"scroll",this.fnHandler),this.eventStatus=!1):(this.fetchBtn?this.bindFetchEvent():f.__addEvent(a,"scroll",this.fnHandler),this.eventStatus=!0)},resetStauts:function(){this.fetchBtn&&(this.fetchBtn.style.display=this.fetchBtn._display),this.__lock=0,this.page++,this.onDone&&this.onDone.call(self)},reset:function(){this.fetchBtn&&(this.fetchBtn.style.display=this.fetchBtn._display),this.__lock=this.sid=this.page=0,this.__imgQueue=[],this.__animateQueue=[],this.todo=[],this.columnHeight=new Array(this.colNum).fill(0),this.colWrap.innerHTML=""}}),f.__version="3.0",f.__calcImgSize=function(a,b){var c=f.__isMobile?200:20,d=a.__imgQueue.slice(),e=setInterval(function(){var c=a.__imgQueue,g=c.length;if(g)for(var h=0;g>h;h++){var i=c[h];i.end?(c.splice(h--,1),g--):(i.width||i.height)&&(i.end=!0)}else{clearInterval(e);for(var h=0;h<d.length;h++)b.call(a,d[h]);f.__handleOpacity(a),a.resetStauts()}},c)},f.__handleOpacity=function(a){clearTimeout(a.qtimmer);var b=a.__animateQueue;!function(){if(b.length){for(var c=0;c<b.length;c++){var d=b[c],e=d.style;d.end?b.splice(c--,1):(e.filter="alpha(opacity="+Math.floor(100*(d.__opacity?d.__opacity:(d.__opacity=0,0)))+")",1===d.__opacity?(d.removeAttribute&&d.removeAttribute("filter"),d.end=!0):d.__opacity+=1/16)}a.qtimmer=setTimeout(arguments.callee,16)}else clearTimeout(a.qtimmer)}()},f.__isMobile=function(){return"ontouchstart"in b}(),f.__addEvent=function(a,b,c){return"function"==typeof addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},f.__detachEvent=function(a,b,c){return"function"==typeof removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},f.__supportCSS3=function(){var a=["","-webkit-","-o-","-moz-","-ms-"],c=b.createElement("div"),d=c.style;return a.some(function(a){return a+"transition"in d})}(),f.__max=function(a){var b=Math.max.apply(Math,a);return{value:b,index:a.indexOf(b)}},f.__min=function(a){var b=Math.min.apply(Math,a);return{value:b,index:a.indexOf(b)}},a.Waterfall=f}(window,document);var el=document.getElementById("start"),navBar=document.getElementById("navBar"),searchBar=document.getElementById("searchBar"),searchBtn=document.getElementById("go"),content=document.getElementById("content"),usercenter=document.getElementById("usercenter"),downloadArea=document.getElementById("download"),mainView=function(){var a={},b=function(b,c){var d=a[b],e=/[\u4e00-\u9fa5]/g,f=new Date(1e3*d.created_at);return d.created_at=f.toLocaleDateString().replace(e,"/")+f.toLocaleTimeString().replace(e,""),d.file_size=(d.file_size/1024).toFixed(2)+"k",d.cwidth=560,d.cheight=560*d.height/d.width,c.replace(/{{([^}]*)}}/g,function(a,b){return d[b]})},c=function(b){b.forEach(function(b){a[b.id]=b})},d=function(b){return a[b]};return{buildPreview:b,cacheData:c,getData:d}}(),mainModel={pageNum:1,tag:"",splitSearch:function(a){switch(!0){case 0===a.indexOf("#"):this.tag=a.slice(1,-1);break;default:this.tag=""}}},wt=new Waterfall({colWrap:content,colClass:"sp",colPrefix:"balabala",imgClass:"sp-m",colNum:4,colWidth:222,flexWidth:200,distance:2e3,resize:!0,maxColNum:5,minColNum:3,pageNum:20,gutterWidth:23,gutterHeight:23,animate:!0,maxPage:20,maxNum:500,hasLayout:!0,customProperty:{width:"sample_width",height:"sample_height"},fetch:function(a){ajax("https://yande.re/post.json?page="+mainModel.pageNum+"&tags="+mainModel.tag,"get").then(function(b){mainView.cacheData(b),mainModel.pageNum++,a(b,"preview_url")},function(a){console.log(a)},function(a){console.log(100*a+"%")})},template:function(a){var b=/[\u4e00-\u9fa5]/g,c=new Date(1e3*a.created_at),d=a.tags.split(" ").map(function(a){return'<em data-tag="'+a+'" title="'+a+'">'+a+"</em>"}),e='<div class="sp-inner" data-id="'+a.id+'"><img src="'+a.preview_url+'" alt="" class="sp-m"><p>'+d+'<span class="sp-download">download</span></p></div><div class="sp-cm"><p><em>id:</em><strong>'+a.id+'</strong></p><p><em>author:</em><strong><a href="">'+a.author+"</a></strong></p><p><em>resolution:</em><strong>"+a.width+"x"+a.height+"</strong></p><p><em>createTime:</em><strong>"+c.toLocaleDateString().replace(b,"/")+c.toLocaleTimeString().replace(b,"")+"</strong></p></div>";return e}}),largeModeView=new Popbox({shortcut:!0,overlay:!0,dragable:!0});$("#content").on("mouseenter",".sp-inner",function(){$(this).find("p").addClass("active")}),$("#content").on("mouseleave",".sp-inner",function(){$(this).find("p").removeClass("active")}),searchBtn.addEventListener("click",function(){mainModel.splitSearch(searchBar.value),mainModel.pageNum=1,wt.reset(),wt.fetchData()},!1),content.addEventListener("click",function(a){var b,c=a.target;if("em"===c.tagName.toLowerCase())return mainModel.tag=c.dataset.tag,searchBar.value="#"+mainModel.tag+"#",mainModel.pageNum=1,wt.reset(),void wt.fetchData();if(c.classList.contains("sp-download")){var d=findParent(c,function(a){return a.classList.contains("sp-inner")}).dataset.id;return void addDownloadTask({target:downloadArea,data:mainView.getData(d),tpl:function(a){var b=a.file_url.split("/").pop();return'<div class="download-bar"><p>'+b+"</p><progress></progress></div>"},onDone:function(){this.taskEl.classList.add("download-done")}})}if(b=findParent(c,function(a){return a.classList.contains("sp-inner")})){var d=b.dataset.id;return void readFile("./view/largeMode.ota").then(function(a){largeModeView.reDraw(function(){return mainView.buildPreview(d,a)}).show()})}},!1),usercenter.addEventListener("click",function(){this.classList.toggle("usercenter-active")}),document.addEventListener("mousewheel",function(a){var b=a.wheelDelta;0>b?navBar.classList.add("nav-bar-fixed"):navBar.classList.remove("nav-bar-fixed")},!1);